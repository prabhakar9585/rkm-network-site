<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>RKM NETWORK SOLUTION - Admin Panel</header>

<div class="tabs">
  <button class="tab pending" onclick="showPending()">Pending Faults (<span id="pendingCount">0</span>)</button>
  <button class="tab resolved" onclick="showResolved()">Resolved Faults (<span id="resolvedCount">0</span>)</button>
  <button class="tab applications" onclick="showApplications()">New Applications</button>
</div>

<div id="content"></div>

<script type="module">
import { db } from "./firebase-init.js";
import {
  collection,
  query,
  where,
  getDocs,
  onSnapshot,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// Load counts
function loadCounts() {
  const pendingQ = query(collection(db,"faults"), where("status","==","pending"));
  const resolvedQ = query(collection(db,"faults"), where("status","==","resolved"));

  getDocs(pendingQ).then(s => document.getElementById("pendingCount").innerText = s.size);
  getDocs(resolvedQ).then(s => document.getElementById("resolvedCount").innerText = s.size);
}
loadCounts();

// ---------------- Pending ----------------
window.showPending = function() {
  const q = query(collection(db,"faults"), where("status","==","pending"));

  onSnapshot(q, snapshot => {
    let html = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      html += `
        <div class="card">
          <h3>${data.landline}</h3>
          <p>${data.name}</p>
          <p>${data.faultType}</p>
          <p>${data.location}</p>
          <textarea id="res-${docSnap.id}" placeholder="Resolution note"></textarea>
          <button onclick="resolveFault('${docSnap.id}')">Resolve</button>
        </div>
      `;
    });
    document.getElementById("content").innerHTML = html;
  });
}

// Resolve
window.resolveFault = async function(id) {
  const note = document.getElementById("res-"+id).value;

  await updateDoc(doc(db,"faults",id), {
    status: "resolved",
    resolutionNote: note
  });

  loadCounts();
}

// ---------------- Resolved ----------------
window.showResolved = function() {
  const q = query(collection(db,"faults"), where("status","==","resolved"));

  onSnapshot(q, snapshot => {
    let html = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      html += `
        <div class="card resolved-card">
          <h3>${data.landline}</h3>
          <p>${data.name}</p>
          <p>${data.faultType}</p>
          <p>${data.location}</p>
          <p><strong>Resolved:</strong> ${data.resolutionNote}</p>
        </div>
      `;
    });
    document.getElementById("content").innerHTML = html;
  });
}

// ---------------- Applications ----------------
window.showApplications = function() {
  onSnapshot(collection(db,"applications"), snapshot => {
    let html = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      html += `
        <div class="card app-card">
          <h3>${data.fullName}</h3>
          <p>${data.mobile}</p>
          <p>${data.alternate}</p>
          <p>${data.address}</p>
        </div>
      `;
    });
    document.getElementById("content").innerHTML = html;
  });
}
</script>

</body>
</html>
