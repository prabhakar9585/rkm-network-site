<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-init.js"></script>
</head>
<body>

<header>
    <h1>Admin Dashboard</h1>
</header>

<div class="tabs">
    <button onclick="showTab('pending')">Pending</button>
    <button onclick="showTab('resolved')">Resolved</button>
    <button onclick="showTab('applications')">Applications</button>
</div>

<div class="dashboard">
    <div class="list-container" id="list"></div>
    <div class="detail-container" id="detail"></div>
</div>

<script type="module">
import { db } from "./firebase-init.js";
import { collection, query, where, onSnapshot, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

let currentTab = "pending";

window.showTab = function(tab){
    currentTab = tab;
    loadData();
};

function loadData(){
    let col = currentTab === "applications" ? "applications" : "faults";
    const list = document.getElementById("list");
    const detail = document.getElementById("detail");
    list.innerHTML = "";
    detail.innerHTML = "";

    let q = collection(db, col);

    if(currentTab !== "applications"){
        q = query(q, where("status","==",currentTab));
    }

    onSnapshot(q, snapshot=>{
        list.innerHTML="";
        snapshot.forEach(docSnap=>{
            const data = docSnap.data();
            const div = document.createElement("div");
            div.className="item-card";

            div.innerHTML = currentTab==="applications"
                ? `<strong>${data.fullName}</strong>`
                : `<strong>${data.custname}</strong>`;

            div.onclick = ()=>{
                if(currentTab==="applications"){
                    detail.innerHTML = `
                        <h3>${data.fullName}</h3>
                        <p>Mobile: ${data.mobile}</p>
                        <p>Aadhaar: ${data.aadhaar}</p>
                        <p>Address: ${data.address}</p>
                    `;
                } else {
                    detail.innerHTML = `
                        <h3>${data.custname}</h3>
                        <p>Landline: ${data.landline}</p>
                        <p>Fault: ${data.faultType}</p>
                        <p>Location: ${data.location}</p>
                        <textarea id="solution"></textarea>
                        <button onclick="resolve('${docSnap.id}')">Resolve</button>
                    `;
                }
            };

            list.appendChild(div);
        });
    });
}

window.resolve = async function(id){
    const solution = document.getElementById("solution").value;
    await updateDoc(doc(db,"faults",id),{
        status:"resolved",
        solution:solution
    });
    alert("Resolved");
};

loadData();
</script>

</body>
</html>
